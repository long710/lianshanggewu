<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»¥å¤ªåŠè½¬è´¦æ·±åº¦è§£æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans SC', sans-serif; }
    .code-font { font-family: 'JetBrains Mono', monospace; }
    .slide { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
    .slide.active { display: flex; opacity: 1; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .neon-text { text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    .blob {
      position: absolute;
      filter: blur(40px);
      z-index: -1;
      opacity: 0.4;
      animation: move 10s infinite alternate;
    }
    @keyframes move {
      from { transform: translate(0, 0) scale(1); }
      to { transform: translate(20px, -20px) scale(1.1); }
    }

    /* Tooltip style */
    .tooltip-trigger:hover .tooltip-content {
      display: block;
    }

    /* Markdown-like styling for AI response */
    .ai-response strong { color: #818cf8; font-weight: 700; }
    .ai-response code { background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 4px; font-family: monospace; color: #fbbf24; }
    .ai-response ul { list-style-type: disc; padding-left: 20px; margin-top: 5px; }
    .ai-response li { margin-bottom: 4px; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden flex flex-col">

<!-- Background Effects -->
<div class="blob bg-purple-600 w-64 h-64 rounded-full top-0 left-0"></div>
<div class="blob bg-blue-600 w-96 h-96 rounded-full bottom-0 right-0 animation-delay-2000"></div>

<!-- Navigation Bar -->
<nav class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-900/80 z-10">
  <div class="flex items-center gap-3">
    <i class="fab fa-ethereum text-3xl text-indigo-400"></i>
    <span class="font-bold text-xl tracking-wider">ETH <span class="text-indigo-400">Deep Dive</span></span>
  </div>
  <div class="text-sm text-slate-400 hidden md:block">
    ä½¿ç”¨ <span class="px-2 py-1 bg-slate-800 rounded border border-slate-600">â†</span> <span class="px-2 py-1 bg-slate-800 rounded border border-slate-600">â†’</span> é”®åˆ‡æ¢
  </div>
  <div class="flex items-center gap-4">
    <div class="text-xs text-right">
      <div class="text-slate-400">è¿›åº¦</div>
      <div id="slide-counter" class="font-bold text-indigo-400">1 / 10</div>
    </div>
    <div class="w-32 h-2 bg-slate-700 rounded-full overflow-hidden">
      <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 10%;"></div>
    </div>
  </div>
</nav>

<!-- Main Content Area -->
<main class="flex-1 relative overflow-hidden flex justify-center items-center p-4 md:p-8">

  <!-- Slide 1: Cover -->
  <div class="slide active flex-col items-center justify-center text-center max-w-4xl w-full h-full" id="slide-0">
    <div class="mb-8 relative">
      <div class="absolute inset-0 bg-indigo-500 blur-3xl opacity-20 rounded-full"></div>
      <i class="fab fa-ethereum text-9xl text-indigo-100 relative z-10 animate-bounce"></i>
    </div>
    <h1 class="text-5xl md:text-7xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400 neon-text">
      ä»¥å¤ªåŠè½¬è´¦å…¨è§£
    </h1>
    <p class="text-xl md:text-2xl text-slate-300 mb-8 max-w-2xl">
      ä»â€œå°ç™½å¬å¾—æ‡‚â€åˆ°â€œç¡¬æ ¸æŠ€æœ¯æ·±ç©¶â€<br>
      <span class="text-sm text-slate-500 mt-2 block">ä¸ä»…æ˜¯è½¬è´¦ï¼Œæ›´æ˜¯ä¸€æ¬¡çŠ¶æ€æœºçš„æ—…è¡Œ</span>
    </p>
    <button onclick="nextSlide()" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full font-bold transition-all transform hover:scale-105 shadow-lg shadow-indigo-500/30">
      å¼€å§‹æ¢ç´¢ <i class="fas fa-arrow-right ml-2"></i>
    </button>
  </div>

  <!-- Slide 2: The Mental Model (Animation) -->
  <div class="slide flex-col max-w-6xl w-full h-full overflow-y-auto" id="slide-1">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">1. æ ¸å¿ƒå¿ƒæ™ºæ¨¡å‹ï¼šçŠ¶æ€æœº</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
      <div class="space-y-6">
        <div class="glass p-6 rounded-xl">
          <h3 class="text-xl font-bold text-indigo-300 mb-2"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i>å°ç™½è§†è§’</h3>
          <p class="text-slate-300 leading-relaxed">
            æƒ³è±¡ä»¥å¤ªåŠæ˜¯ä¸€ä¸ªå·¨å¤§çš„<strong>å…¨çƒExcelè¡¨æ ¼</strong>ã€‚
            è½¬è´¦ä¸æ˜¯æŠŠç¡¬å¸ä»Aæ‰”åˆ°Bï¼Œè€Œæ˜¯ï¼š
            <br>1. æŠŠAçš„ä½™é¢æ”¹æˆ `Old - X`
            <br>2. æŠŠBçš„ä½™é¢æ”¹æˆ `Old + X`
            <br>æ‰€æœ‰çš„ç”µè„‘ï¼ˆèŠ‚ç‚¹ï¼‰å¿…é¡»å¯¹è¿™æ¬¡ä¿®æ”¹è¾¾æˆä¸€è‡´ã€‚
          </p>
        </div>
        <div class="glass p-6 rounded-xl border-l-4 border-red-500">
          <h3 class="text-xl font-bold text-red-300 mb-2"><i class="fas fa-code text-red-400 mr-2"></i>æ·±ç©¶ï¼šä¸–ç•ŒçŠ¶æ€ (World State)</h3>
          <p class="text-slate-400 text-sm leading-relaxed mb-2">
            ä»¥å¤ªåŠä¸ä»…æ˜¯è´¦æœ¬ï¼Œå®ƒæ˜¯<strong>äº¤æ˜“é©±åŠ¨çš„çŠ¶æ€æœº</strong> (Transaction-based State Machine)ã€‚
          </p>
          <div class="code-font bg-black/50 p-3 rounded text-xs text-green-400">
            Ïƒ' = Î¥(Ïƒ, T)<br>
            // Ïƒ (Sigma) æ˜¯å½“å‰çŠ¶æ€<br>
            // T æ˜¯äº¤æ˜“<br>
            // Î¥ (Upsilon) æ˜¯çŠ¶æ€è½¬æ¢å‡½æ•° (EVM)
          </div>
        </div>
      </div>
      <!-- Animation Container -->
      <div class="flex flex-col h-full min-h-[300px]">
        <div class="bg-slate-800/80 rounded-xl shadow-2xl flex-1 relative border border-slate-700 p-4 flex flex-col items-center justify-center overflow-hidden" id="anim-stage">
          <div class="absolute top-8 left-8 p-3 bg-slate-700 rounded border border-slate-600 w-24 text-center transition-all duration-500 z-10" id="anim-alice-box">
            <div class="text-xs text-slate-400 mb-1"><i class="fas fa-user text-blue-400"></i> Alice</div>
            <div class="font-mono text-white font-bold text-sm" id="anim-alice-val">10 ETH</div>
          </div>
          <div class="absolute top-8 right-8 p-3 bg-slate-700 rounded border border-slate-600 w-24 text-center transition-all duration-500 z-10" id="anim-bob-box">
            <div class="text-xs text-slate-400 mb-1"><i class="fas fa-user text-purple-400"></i> Bob</div>
            <div class="font-mono text-white font-bold text-sm" id="anim-bob-val">0 ETH</div>
          </div>
          <div class="relative z-0 mt-12 flex flex-col items-center justify-center">
            <div class="w-24 h-24 bg-indigo-900/50 rounded-full border-2 border-indigo-500 flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.3)] transition-all duration-300" id="anim-evm-ring">
              <i class="fas fa-cogs text-4xl text-indigo-400" id="anim-gear"></i>
            </div>
            <div class="text-xs text-center mt-2 font-bold text-indigo-300">EVM (çŠ¶æ€æœº)</div>
          </div>
          <div id="anim-tx" class="absolute w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-slate-900 font-bold text-xs shadow-lg z-20 opacity-0 pointer-events-none">
            Tx
            <span class="absolute -bottom-4 text-[10px] text-yellow-500 whitespace-nowrap">2 ETH</span>
          </div>
          <div id="anim-status" class="mt-6 text-sm text-slate-500 font-mono h-6 text-center">ç­‰å¾…æŒ‡ä»¤...</div>
        </div>
        <button onclick="runStateAnimation()" class="mt-4 mx-auto px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full font-bold text-sm transition-all shadow-lg flex items-center gap-2 group">
          <i class="fas fa-play group-hover:scale-110 transition-transform"></i> è¿è¡ŒçŠ¶æ€è½¬æ¢
        </button>
      </div>
    </div>
  </div>

  <!-- Slide 3: Account Types (REVISED) -->
  <div class="slide flex-col max-w-6xl w-full h-full" id="slide-2">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">2. è°åœ¨è½¬è´¦ï¼Ÿè´¦æˆ·æ¨¡å‹</h2>

    <div class="flex flex-col md:flex-row gap-6 items-stretch justify-center h-full pb-10 overflow-y-auto">
      <!-- EOA -->
      <div class="flex-1 glass p-6 rounded-2xl border-t-4 border-blue-500 hover:bg-slate-800/50 transition-colors flex flex-col">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-2xl"><i class="fas fa-user"></i></div>
          <div>
            <h3 class="text-xl font-bold">å¤–éƒ¨æ‹¥æœ‰è´¦æˆ· (EOA)</h3>
            <p class="text-xs text-slate-400">MetaMask, Ledger...</p>
          </div>
        </div>
        <ul class="space-y-4 text-sm text-slate-300 flex-1">
          <li><i class="fas fa-key text-green-500 mr-2"></i>ç”± <strong>ç§é’¥</strong> æ§åˆ¶</li>
          <li><i class="fas fa-paper-plane text-green-500 mr-2"></i>å‘èµ·æ‰€æœ‰äº¤æ˜“çš„æºå¤´</li>

          <!-- Explained Gas Cost -->
          <li class="tooltip-trigger relative cursor-help">
            <div class="flex items-center p-2 bg-slate-800 rounded border border-slate-700 hover:border-indigo-500 transition-colors">
              <i class="fas fa-gas-pump text-orange-400 mr-3"></i>
              <div>
                <div class="font-bold text-orange-200">21,000 Gas (èµ·æ­¥ä»·)</div>
                <div class="text-xs text-slate-500">ä»€ä¹ˆæ„æ€ï¼Ÿé¼ æ ‡æ”¾è¿™é‡Œçœ‹çœ‹</div>
              </div>
            </div>
            <!-- Tooltip Content -->
            <div class="tooltip-content hidden absolute top-full left-0 mt-2 p-3 bg-black/95 rounded-lg border border-slate-600 z-50 text-xs leading-relaxed w-64 shadow-2xl">
              <strong class="text-orange-400 block mb-1">é€šä¿—è§£é‡Šï¼š</strong>
              è¿™å°±åƒå‡ºç§Ÿè½¦çš„â€œèµ·æ­¥ä»·â€ã€‚<br>
              åªè¦æ˜¯ä¸€ç¬”æ™®é€šè½¬è´¦ï¼Œä»¥å¤ªåŠç½‘ç»œå°±éœ€è¦æ‰§è¡Œä¸€å¥—å›ºå®šçš„åŠ¨ä½œï¼ˆæ£€æŸ¥ç­¾åã€ä¿®æ”¹Aä½™é¢ã€ä¿®æ”¹Bä½™é¢ï¼‰ã€‚<br>
              è¿™å¥—åŠ¨ä½œæ¶ˆè€—çš„ç®—åŠ›æ˜¯å›ºå®šçš„ 21,000 å•ä½ã€‚
            </div>
          </li>

          <li class="pt-4 border-t border-slate-700 mt-2">
            <span class="text-blue-300 font-bold block mb-2">æ·±ç©¶ï¼šåœ°å€æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ</span>
            <div class="code-font text-[10px] md:text-xs bg-black/30 p-2 rounded text-slate-400 overflow-x-auto border border-slate-700/50 mb-2">
              Address = Keccak256(PubKey)[-20:]
            </div>
            <div class="grid grid-cols-1 gap-1 text-[10px] text-slate-500 pl-2 border-l-2 border-slate-600">
              <div><span class="text-indigo-400 font-bold">Keccak256</span>: å“ˆå¸Œå‡½æ•°ï¼ŒæŠŠä»»æ„æ•°æ®å˜æˆä¸€ä¸²ä¹±ç ã€‚</div>
              <div><span class="text-indigo-400 font-bold">PubKey</span>: ä½ çš„å…¬é’¥ï¼ˆä»ç§é’¥æ¨å¯¼å‡ºçš„64å­—èŠ‚ï¼‰ã€‚</div>
              <div><span class="text-indigo-400 font-bold">[-20:]</span>: å“ˆå¸Œç®—å‡ºæ¥å¾ˆé•¿(32å­—èŠ‚)ï¼Œåªå–æœ€å20å­—èŠ‚ä½œä¸ºåœ°å€ã€‚</div>
            </div>
          </li>
        </ul>
      </div>

      <!-- Contract -->
      <div class="flex-1 glass p-6 rounded-2xl border-t-4 border-purple-500 hover:bg-slate-800/50 transition-colors flex flex-col">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-2xl"><i class="fas fa-file-code"></i></div>
          <div>
            <h3 class="text-xl font-bold">åˆçº¦è´¦æˆ· (CA)</h3>
            <p class="text-xs text-slate-400">USDT, Uniswap...</p>
          </div>
        </div>
        <ul class="space-y-4 text-sm text-slate-300 flex-1">
          <li><i class="fas fa-robot text-purple-400 mr-2"></i>ç”± <strong>ä»£ç é€»è¾‘</strong> æ§åˆ¶</li>
          <li><i class="fas fa-database text-purple-400 mr-2"></i>åŒ…å«ä»£ç (Code)å’Œå­˜å‚¨(Storage)</li>

          <li class="pt-4 border-t border-slate-700 mt-2">
            <span class="text-purple-300 font-bold block mb-2">æ·±ç©¶ï¼šåˆçº¦åœ°å€ç”Ÿæˆå…¬å¼</span>

            <!-- Method 1 -->
            <div class="mb-3">
              <div class="text-xs font-bold text-slate-400 mb-1">æ–¹å¼ 1: CREATE (ä¼ ç»Ÿéƒ¨ç½²)</div>
              <div class="code-font text-[10px] bg-black/30 p-2 rounded text-slate-300 border border-slate-700/50">
                Hash(Sender, Nonce)
              </div>
              <div class="mt-1 text-[10px] text-slate-500 pl-2 border-l-2 border-slate-700">
                <span class="text-purple-400">Sender(è°éƒ¨ç½²çš„)</span> + <span class="text-purple-400">Nonce(ä»–å‘å‡ºçš„ç¬¬å‡ ç¬”äº¤æ˜“)</span>ã€‚<br>
                ç»“è®ºï¼šåªè¦çŸ¥é“æ˜¯è°åœ¨ä»€ä¹ˆæ—¶å€™å‘çš„ï¼Œåœ°å€å°±èƒ½ç®—å‡ºæ¥ã€‚
              </div>
            </div>

            <!-- Method 2 -->
            <div>
              <div class="text-xs font-bold text-slate-400 mb-1">æ–¹å¼ 2: CREATE2 (ç¡®å®šæ€§éƒ¨ç½²)</div>
              <div class="code-font text-[10px] bg-black/30 p-2 rounded text-slate-300 border border-slate-700/50">
                Hash(0xFF, Sender, Salt, CodeHash)
              </div>
              <div class="mt-1 text-[10px] text-slate-500 pl-2 border-l-2 border-slate-700 space-y-1">
                <div><span class="text-purple-400 font-bold">0xFF</span>: å›ºå®šå‰ç¼€ï¼Œé˜²æ­¢å’Œæ–¹å¼1å†²çªã€‚</div>
                <div><span class="text-purple-400 font-bold">Salt</span>: ç›ï¼Œç”¨æˆ·è‡ªå·±éšä¾¿å¡«çš„ä¸€ä¸ªéšæœºæ•°ã€‚</div>
                <div><span class="text-purple-400 font-bold">CodeHash</span>: åˆçº¦ä»£ç å†…å®¹çš„æŒ‡çº¹(å“ˆå¸Œ)ã€‚</div>
                <div class="text-slate-400 italic">âœ¨ åªè¦ä»£ç ä¸å˜ã€ç›ä¸å˜ï¼Œåœ°å€å°±æ°¸è¿œå›ºå®šï¼ä¸éœ€è¦å…ˆéƒ¨ç½²å°±èƒ½çŸ¥é“åœ°å€ã€‚</div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Slide 4: Anatomy of a Transaction (Interactive) -->
  <div class="slide flex-col max-w-6xl w-full h-full overflow-y-auto" id="slide-3">
    <h2 class="text-3xl font-bold mb-4 border-l-4 border-indigo-500 pl-4">3. è§£å‰–ä¸€åªâ€œäº¤æ˜“â€</h2>
    <p class="text-slate-400 mb-6">ç‚¹å‡»ä¸‹æ–¹å­—æ®µæŸ¥çœ‹åº•å±‚äºŒè¿›åˆ¶å«ä¹‰</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- The Visualization -->
      <div class="space-y-2">
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('nonce')">
          <span class="text-xs text-slate-500">01</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-indigo-300">Nonce</span>
            <span class="code-font text-xs text-slate-400">5</span>
          </div>
        </div>
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('gas')">
          <span class="text-xs text-slate-500">02</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-pink-300">Gas Fee Cap / Tip</span>
            <span class="code-font text-xs text-slate-400">30 Gwei</span>
          </div>
        </div>
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('to')">
          <span class="text-xs text-slate-500">03</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-blue-300">To (Receiver)</span>
            <span class="code-font text-xs text-slate-400">0xAb5...</span>
          </div>
        </div>
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('value')">
          <span class="text-xs text-slate-500">04</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-green-300">Value</span>
            <span class="code-font text-xs text-slate-400">1.5 ETH</span>
          </div>
        </div>
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('data')">
          <span class="text-xs text-slate-500">05</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-yellow-300">Data / Input</span>
            <span class="code-font text-xs text-slate-400">0xa9059cbb...</span>
          </div>
        </div>
        <div class="p-4 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-all border border-slate-600 tx-field" onclick="showTxDetail('sig')">
          <span class="text-xs text-slate-500">06</span>
          <div class="flex justify-between items-center">
            <span class="font-bold text-purple-300">v, r, s (Signature)</span>
            <span class="code-font text-xs text-slate-400">ECDSA...</span>
          </div>
        </div>
      </div>

      <!-- Detail Panel -->
      <div class="glass p-6 rounded-xl flex flex-col justify-center min-h-[400px]">
        <div id="tx-detail-content" class="text-center">
          <i class="fas fa-hand-pointer text-4xl text-slate-600 mb-4 animate-bounce"></i>
          <p class="text-slate-400">ç‚¹å‡»å·¦ä¾§å­—æ®µæŸ¥çœ‹æ·±åº¦æŠ€æœ¯ç»†èŠ‚</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Slide 5: Gas Logic (EIP-1559) & Acceleration -->
  <div class="slide flex-col max-w-6xl w-full h-full" id="slide-4">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">4. Gas æ·±åº¦ï¼šç«ä»·ã€æ‹¥å µä¸äº¤æ˜“åŠ é€Ÿ</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full overflow-y-auto pb-4">
      <!-- Left: Deep Dive Theory -->
      <div class="space-y-5">
        <!-- Formula Block -->
        <div class="bg-slate-800 p-4 rounded-lg border border-slate-600">
          <h3 class="font-bold text-indigo-300 mb-2 text-sm">EIP-1559 è®¡è´¹å…¬å¼</h3>
          <div class="font-mono text-xs md:text-sm bg-black/40 p-2 rounded mb-2">
            Fee = (Base Fee + <span class="text-green-400 font-bold">Priority Fee</span>) * Gas Used
          </div>
          <p class="text-xs text-slate-400">
            æ™®é€šè½¬è´¦ Gas Used å›ºå®šä¸º <span class="text-indigo-300 font-bold">21,000</span>ã€‚
          </p>
        </div>

        <!-- Speed & Acceleration Logic -->
        <div class="glass p-5 rounded-xl border-l-4 border-green-500">
          <h3 class="font-bold text-lg mb-2 text-green-300"><i class="fas fa-tachometer-alt mr-2"></i>ä¸ºä»€ä¹ˆäº¤æ˜“æœ‰å¿«æ…¢ï¼Ÿ</h3>
          <div class="text-sm text-slate-300 space-y-3">
            <p>
              <strong>1. çŸ¿å·¥çš„è´ªå©ªï¼š</strong> å†…å­˜æ±  (Mempool) é‡Œå¯èƒ½æœ‰ 5000 ç¬”äº¤æ˜“åœ¨æ’é˜Ÿï¼Œä½†ä¸€ä¸ªåŒºå—åªèƒ½è£… 500 ç¬”ã€‚çŸ¿å·¥ä¼šæŠŠæ‰€æœ‰äº¤æ˜“æŒ‰ <span class="text-green-400 font-bold">Priority Fee (å°è´¹)</span> ä»é«˜åˆ°ä½æ’åºã€‚ç»™å¾—è¶Šå¤šï¼Œæ’å¾—è¶Šå‰ã€‚
            </p>
            <p>
              <strong>2. äº¤æ˜“åŠ é€Ÿ (Speed Up) çš„æœ¬è´¨ï¼š</strong>
              å¾ˆå¤šé’±åŒ…æœ‰â€œåŠ é€Ÿâ€æŒ‰é’®ã€‚è¿™å…¶å®ä¸æ˜¯ä¿®æ”¹æ—§äº¤æ˜“ï¼Œè€Œæ˜¯å‘å‡ºä¸€ç¬” <span class="text-yellow-400 font-bold">æ–°çš„äº¤æ˜“</span>ï¼š
              <br>â€¢ <strong>Nonce ç›¸åŒ</strong> (å¿…é¡»å’Œå¡ä½çš„é‚£ç¬”ä¸€æ ·)
              <br>â€¢ <strong>Gas Price æ›´é«˜</strong> (é€šå¸¸åŠ ä»· 10% ä»¥ä¸Š)
              <br>ä¸€æ—¦æ–°äº¤æ˜“è¢«æ‰“åŒ…ï¼Œæ—§äº¤æ˜“å›  Nonce é‡å¤ä¼šè¢«å…¨ç½‘ä¸¢å¼ƒã€‚
            </p>
          </div>
        </div>

        <!-- Base Fee Mechanism -->
        <div class="glass p-5 rounded-xl border-l-4 border-red-500">
          <h3 class="font-bold text-lg mb-2 text-red-300"><i class="fas fa-chart-line mr-2"></i>Base Fee ä¸ºä»€ä¹ˆä¼šå˜ï¼Ÿ</h3>
          <p class="text-sm text-slate-300">
            è¿™æ˜¯ç³»ç»Ÿçš„è‡ªåŠ¨è°ƒèŠ‚æœºåˆ¶ã€‚å¦‚æœä¸Šä¸€ä¸ªåŒºå—ä½¿ç”¨ç‡ > 50%ï¼ˆæ‹¥å µï¼‰ï¼ŒBase Fee è‡ªåŠ¨ä¸Šæ¶¨ 12.5%ã€‚å¦‚æœä¸æ‹¥å µï¼Œå°±ä¸‹è·Œã€‚
            <br><span class="text-xs text-slate-500 mt-1 block">è¿™æ„å‘³ç€ï¼šé«˜å³°æœŸæ¯è¿‡ 12 ç§’ï¼ŒåŸºç¡€è·¯è´¹å°±å¯èƒ½è´µä¸€å€ã€‚</span>
          </p>
        </div>
      </div>

      <!-- Right: Interactive Simulator -->
      <div class="bg-slate-800/50 rounded-xl p-6 flex flex-col border border-slate-700">
        <h3 class="text-lg font-bold mb-4 flex items-center justify-between">
          <span>ç«ä»·æ¨¡æ‹Ÿå™¨</span>
          <span class="text-xs font-normal text-slate-400 bg-slate-800 px-2 py-1 rounded">å½“å‰ç½‘ç»œå»ºè®®å°è´¹: 2.0 Gwei</span>
        </h3>

        <!-- Controls -->
        <div class="space-y-4 mb-6">
          <div class="flex justify-between items-center text-sm">
            <span class="text-slate-300">ä½ çš„å°è´¹ (Priority Fee):</span>
            <div class="flex items-center gap-2">
              <input type="number" id="prio-fee" value="1.5" step="0.1" class="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-right font-bold text-green-400 focus:outline-none focus:border-indigo-500" oninput="updateMempoolViz()">
              <span class="text-slate-500 text-xs">Gwei</span>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="setFee(1.0)" class="flex-1 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300 transition-colors">ğŸ¢ æ…¢é€Ÿ</button>
            <button onclick="setFee(2.0)" class="flex-1 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300 transition-colors">ğŸš— æ ‡å‡†</button>
            <button onclick="setFee(5.0)" class="flex-1 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs text-slate-300 transition-colors">ğŸš€ æé€Ÿ</button>
          </div>
          <button onclick="accelerateTx()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded shadow-lg shadow-indigo-500/30 transition-all active:scale-95">
            <i class="fas fa-bolt mr-2"></i>ä¸€é”®åŠ é€Ÿ (å°è´¹ +30%)
          </button>
        </div>

        <!-- Visualization -->
        <div class="flex-1 bg-slate-900 rounded-lg p-4 relative overflow-hidden border border-slate-700 flex flex-col-reverse gap-1" id="mempool-viz">
          <!-- Bars will be generated by JS -->
          <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
            <div class="text-xs text-slate-500 uppercase tracking-widest font-bold opacity-30">Mempool Priority Queue</div>
          </div>
        </div>

        <div class="mt-4 flex justify-between items-end">
          <div>
            <div class="text-xs text-slate-400">é¢„è®¡æ‰“åŒ…æ—¶é—´</div>
            <div class="text-xl font-bold text-white" id="est-time">--</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-400">æ€»è´¹ç”¨ (Base: 15)</div>
            <div class="text-sm font-bold text-indigo-300" id="total-cost-display">-- ETH</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Slide 6: The Data Field (Input Data) -->
  <div class="slide flex-col max-w-5xl w-full h-full overflow-y-auto" id="slide-5">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">5. Data å­—æ®µï¼šæ™®é€šè½¬è´¦ vs ä»£å¸è½¬è´¦</h2>

    <div class="space-y-6">
      <!-- Case 1: ETH Transfer -->
      <div class="glass p-5 rounded-xl border-l-4 border-green-500">
        <h3 class="font-bold text-lg mb-2">æƒ…å½¢ Aï¼šè½¬è´¦ ETH</h3>
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
          <div class="md:col-span-3 text-slate-400 text-sm">To:</div>
          <div class="md:col-span-9 code-font text-sm">æ¥æ”¶è€…åœ°å€ (Bob)</div>

          <div class="md:col-span-3 text-slate-400 text-sm">Value:</div>
          <div class="md:col-span-9 code-font text-sm">1.0 ETH</div>

          <div class="md:col-span-3 text-slate-400 text-sm">Data:</div>
          <div class="md:col-span-9 code-font text-sm text-slate-500">0x (ä¸ºç©º)</div>
        </div>
      </div>

      <!-- Case 2: ERC20 Transfer -->
      <div class="glass p-5 rounded-xl border-l-4 border-yellow-500">
        <h3 class="font-bold text-lg mb-2">æƒ…å½¢ Bï¼šè½¬è´¦ USDT (ERC-20) <span class="text-xs bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded ml-2">è¿™é‡Œå¾ˆå¤šäººä¼šææ··ï¼</span></h3>
        <p class="text-sm text-slate-400 mb-3">å½“ä½ è½¬ USDT æ—¶ï¼Œä½ å®é™…ä¸Šæ˜¯åœ¨<strong>è°ƒç”¨ USDT çš„åˆçº¦</strong>ã€‚</p>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 bg-black/30 p-4 rounded text-sm">
          <div class="md:col-span-3 text-slate-400">To:</div>
          <div class="md:col-span-9 code-font text-yellow-300">USDT åˆçº¦åœ°å€ (ä¸æ˜¯ Bob!)</div>

          <div class="md:col-span-3 text-slate-400">Value:</div>
          <div class="md:col-span-9 code-font">0 ETH (å› ä¸ºä½ æ²¡è½¬ ETH)</div>

          <div class="md:col-span-3 text-slate-400">Data:</div>
          <div class="md:col-span-9 break-all code-font">
            <span class="text-red-400" title="Method ID">0xa9059cbb</span>
            <span class="text-green-400" title="Padding + Address">000000000000000000000000<span class="underline">Bobçš„åœ°å€</span></span>
            <span class="text-blue-400" title="Amount">0000000000000000000000000000000000000000000000000000000005F5E100</span>
          </div>
        </div>

        <div class="mt-4 flex gap-2 text-xs">
          <div class="flex items-center"><span class="w-3 h-3 bg-red-400 inline-block mr-1"></span> å‡½æ•°é€‰æ‹©å™¨ (transfer)</div>
          <div class="flex items-center"><span class="w-3 h-3 bg-green-400 inline-block mr-1"></span> å‚æ•°1 (Bob)</div>
          <div class="flex items-center"><span class="w-3 h-3 bg-blue-400 inline-block mr-1"></span> å‚æ•°2 (é‡‘é¢)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Slide 7: Nonce Deep Dive -->
  <div class="slide flex-col max-w-5xl w-full h-full" id="slide-6">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">6. Nonce: é˜²é‡æ”¾æ”»å‡»çš„å…³é”®</h2>

    <div class="flex flex-col md:flex-row gap-8 items-center h-full">
      <div class="flex-1 space-y-4">
        <p class="text-lg text-slate-300">Nonce æ˜¯è¯¥åœ°å€å‘é€äº¤æ˜“çš„<strong>è®¡æ•°å™¨</strong>ã€‚</p>
        <ul class="list-disc list-inside space-y-2 text-slate-400">
          <li>ç¬¬ä¸€ç¬”äº¤æ˜“ Nonce = 0</li>
          <li>ç¬¬äºŒç¬”äº¤æ˜“ Nonce = 1</li>
          <li>å¿…é¡»ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œã€‚</li>
        </ul>
        <div class="glass p-4 rounded-lg mt-6 border border-red-500/30">
          <h4 class="text-red-300 font-bold mb-2">å¦‚æœæ²¡æœ‰ Nonce ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h4>
          <p class="text-sm">é»‘å®¢å¯ä»¥æŠŠä½ â€œç»™Aè½¬10å—é’±â€çš„è¿™ä¸ªäº¤æ˜“å¹¿æ’­æ•°æ®ï¼Œå¤åˆ¶ä¸€ä»½å†å‘ç»™èŠ‚ç‚¹ã€‚èŠ‚ç‚¹æ— æ³•åŒºåˆ†è¿™æ˜¯æ–°çš„æŒ‡ä»¤è¿˜æ˜¯æ—§çš„ï¼Œå¯¼è‡´ä½ çš„é’±è¢«é‡å¤æ‰£é™¤ï¼ˆé‡æ”¾æ”»å‡»ï¼‰ã€‚</p>
        </div>
        <div class="glass p-4 rounded-lg mt-2 border border-blue-500/30">
          <h4 class="text-blue-300 font-bold mb-2">å®ç”¨æŠ€å·§ï¼šåŠ é€Ÿ/å–æ¶ˆäº¤æ˜“</h4>
          <p class="text-sm">å¦‚æœ Nonce=5 çš„äº¤æ˜“å¡ä½äº†ï¼Œä½ å¯ä»¥å‘ä¸€ç¬”æ–°çš„ Nonce=5 çš„äº¤æ˜“ï¼Œç»™æ›´é«˜çš„ Gas è´¹ã€‚æ–°äº¤æ˜“ä¸€æ—¦è¢«æ‰“åŒ…ï¼Œæ—§äº¤æ˜“è‡ªåŠ¨ä½œåºŸã€‚</p>
        </div>
      </div>

      <div class="flex-1 bg-slate-800 p-6 rounded-xl w-full max-w-md relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent"></div>
        <div class="space-y-4">
          <div class="flex items-center justify-between opacity-50">
            <div class="bg-slate-700 px-3 py-1 rounded text-xs">Tx 1</div>
            <div class="text-xs text-slate-500">Nonce: 0 (å·²ç¡®è®¤)</div>
          </div>
          <div class="flex items-center justify-between opacity-50">
            <div class="bg-slate-700 px-3 py-1 rounded text-xs">Tx 2</div>
            <div class="text-xs text-slate-500">Nonce: 1 (å·²ç¡®è®¤)</div>
          </div>
          <div class="flex items-center justify-between bg-indigo-900/40 p-2 rounded border border-indigo-500">
            <div class="bg-indigo-600 px-3 py-1 rounded text-xs">Tx 3</div>
            <div class="text-xs text-indigo-300 font-bold">Nonce: 2 (å¤„ç†ä¸­...)</div>
          </div>
          <div class="flex items-center justify-between opacity-30">
            <div class="bg-slate-700 px-3 py-1 rounded text-xs">Tx 4</div>
            <div class="text-xs text-red-400">Nonce: 3 (æ’é˜Ÿä¸­)</div>
          </div>
          <p class="text-xs text-center text-slate-500 mt-4">å¦‚æœ Tx 3 å¡ä½ï¼ŒTx 4 æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Slide 8: The Journey (Revised: Animation & MEV) -->
  <div class="slide flex-col max-w-6xl w-full h-full overflow-y-auto" id="slide-7">
    <h2 class="text-3xl font-bold mb-6 border-l-4 border-indigo-500 pl-4">7. å…±è¯†ä¹‹æ—…ï¼šä»ç­¾ååˆ°æœ€ç»ˆç¡®è®¤ (å« MEV)</h2>

    <!-- Top: Animation Stage -->
    <div class="w-full bg-slate-800/80 rounded-xl border border-slate-700 p-6 mb-6 relative overflow-hidden min-h-[220px] flex items-center justify-between" id="journey-stage">

      <!-- Nodes in diagram -->
      <div class="z-10 flex flex-col items-center">
        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-2xl shadow-lg shadow-blue-500/50 relative">
          <i class="fas fa-wallet"></i>
        </div>
        <div class="mt-2 font-bold text-sm">1. ç­¾å</div>
        <div class="text-[10px] text-slate-400">ç§é’¥ (ECDSA)</div>
      </div>

      <div class="z-10 flex flex-col items-center relative">
        <!-- MEV Bot (Hidden initially) -->
        <div id="sandwich-bot" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-red-900/90 text-red-300 px-2 py-1 rounded text-[10px] whitespace-nowrap opacity-0 transition-opacity duration-300 border border-red-500">
          <i class="fas fa-robot"></i> å‘ç°è‚¥ç¾Š! å¤¹å®ƒ!
        </div>

        <div class="w-32 h-20 bg-slate-700/50 border border-slate-500 border-dashed rounded-lg flex items-center justify-center text-3xl text-purple-400 relative">
          <i class="fas fa-network-wired"></i>
          <!-- Small txs inside -->
          <div class="absolute w-2 h-2 bg-slate-400 rounded-full top-2 left-2 opacity-50"></div>
          <div class="absolute w-2 h-2 bg-slate-400 rounded-full bottom-3 right-4 opacity-50"></div>
        </div>
        <div class="mt-2 font-bold text-sm text-purple-300">2. Mempool (å¹¿æ’­)</div>
        <div class="text-[10px] text-red-400 font-bold">âš ï¸ MEV å±é™©åŒº</div>
      </div>

      <div class="z-10 flex flex-col items-center">
        <div class="w-16 h-16 bg-green-600 rounded-lg flex items-center justify-center text-2xl shadow-lg shadow-green-500/30 relative">
          <i class="fas fa-cube"></i>
          <div id="finality-badge" class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center text-[10px] text-black font-bold border-2 border-slate-900 transition-colors">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="mt-2 font-bold text-sm">3. åŒºå— & ç¡®è®¤</div>
        <div class="text-[10px] text-slate-400" id="finality-text">ç­‰å¾… Justified...</div>
      </div>

      <!-- Connection Lines -->
      <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-700 -translate-y-8 z-0"></div>

      <!-- The Traveling Ball (User TX) -->
      <div id="j-tx-ball" class="absolute w-8 h-8 bg-yellow-400 rounded-full border-2 border-white shadow-lg z-20 flex items-center justify-center text-slate-900 font-bold text-[10px] opacity-0 transition-all duration-700">
        Tx
      </div>

      <!-- Bot TXs (Front/Back) -->
      <div id="bot-tx-front" class="absolute w-6 h-6 bg-red-500 rounded-full z-20 opacity-0 transition-all duration-500 flex items-center justify-center text-[8px] text-white">Bot</div>
      <div id="bot-tx-back" class="absolute w-6 h-6 bg-red-500 rounded-full z-20 opacity-0 transition-all duration-500 flex items-center justify-center text-[8px] text-white">Bot</div>
    </div>

    <!-- Controls -->
    <div class="text-center mb-6">
      <button onclick="runJourneyAnim()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full font-bold shadow-lg transition-transform hover:scale-105 active:scale-95 text-sm">
        <i class="fas fa-play mr-2"></i> æ¨¡æ‹Ÿäº¤æ˜“æµç¨‹ (å« MEV æ”»å‡»)
      </button>
    </div>

    <!-- Explanations -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">
      <!-- MEV Deep Dive -->
      <div class="glass p-5 rounded-xl border-l-4 border-red-500">
        <h3 class="font-bold text-lg mb-2 text-red-300"><i class="fas fa-hamburger mr-2"></i>ä¸‰æ˜æ²»æ”»å‡» (Sandwich Attack)</h3>
        <p class="text-sm text-slate-300 mb-3">
          å‘ç”Ÿåœ¨ <strong>Mempool</strong> é˜¶æ®µã€‚
          <br><span class="text-xs text-yellow-500">å…³é”®ç‚¹ï¼šåŒä¸€ä¸ªåŒºå—å†…çš„äº¤æ˜“æ˜¯<strong>æœ‰å…ˆåé¡ºåº</strong>çš„ï¼</span>
        </p>
        <div class="text-xs bg-slate-900/50 p-3 rounded border border-slate-600 space-y-2">
          <div class="flex gap-2 bg-slate-800 p-2 rounded mb-2">
            <span class="text-indigo-400 font-bold min-w-[40px]">åŸç†:</span>
            <span>çŸ¿å·¥æŒ‰ <strong>Gas å°è´¹</strong> æ’åºã€‚è°ç»™é’±å¤šï¼Œè°å°±æ’åœ¨åŒºå—çš„å‰é¢å…ˆæ‰§è¡Œ (Index 0)ï¼Œç»™é’±å°‘çš„æ’åé¢ (Index 1)ã€‚</span>
          </div>

          <div class="flex gap-2 items-center">
            <span class="bg-red-900 text-red-300 px-1 rounded font-bold min-w-[50px] text-center">Step 1</span>
            <div>
              <strong class="text-red-400">æŠ¢è·‘ (Front-run):</strong>
              <div class="text-slate-400">æœºå™¨äººå‡ºä»· <strong>20 Gwei</strong>ã€‚çŸ¿å·¥è®©å®ƒå…ˆä¹°ï¼Œæ¨é«˜ä»·æ ¼ã€‚</div>
            </div>
          </div>

          <div class="flex gap-2 items-center">
            <span class="bg-yellow-900 text-yellow-300 px-1 rounded font-bold min-w-[50px] text-center">Step 2</span>
            <div>
              <strong class="text-yellow-400">ä½ ä¹° (Victim):</strong>
              <div class="text-slate-400">ä½ å‡ºä»· <strong>15 Gwei</strong>ã€‚ä½ åœ¨å®ƒåé¢æ‰§è¡Œï¼Œè¢«è¿«é«˜ä»·æ¥ç›˜ã€‚</div>
            </div>
          </div>

          <div class="flex gap-2 items-center">
            <span class="bg-blue-900 text-blue-300 px-1 rounded font-bold min-w-[50px] text-center">Step 3</span>
            <div>
              <strong class="text-blue-400">æŠ›å”® (Back-run):</strong>
              <div class="text-slate-400">æœºå™¨äººå‡ºä»· <strong>10 Gwei</strong>ã€‚å®ƒæ’æœ€åï¼ŒæŠŠä½ åˆšæ‹‰é«˜çš„ä»·æ ¼ç ¸ç›˜è·åˆ©ã€‚</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Finality Logic -->
      <div class="glass p-5 rounded-xl border-l-4 border-green-500 flex flex-col justify-center">
        <h3 class="font-bold text-lg mb-2 text-green-300"><i class="fas fa-check-double mr-2"></i>æœ€ç»ˆç¡®è®¤æ€§</h3>
        <ul class="space-y-3 text-sm text-slate-300">
          <li class="flex items-center gap-2">
            <i class="fas fa-stopwatch text-yellow-400 w-4"></i>
            <span><strong>12ç§’:</strong> ä¸€ä¸ª Slot (å‡ºå—)ã€‚æ­¤æ—¶äº¤æ˜“å¯é€†ã€‚</span>
          </li>
          <li class="flex items-center gap-2">
            <i class="fas fa-hourglass-half text-blue-400 w-4"></i>
            <span><strong>~6.4åˆ†é’Ÿ (1 Epoch):</strong> å˜æˆ Justifiedã€‚</span>
          </li>
          <li class="flex items-center gap-2">
            <i class="fas fa-lock text-green-400 w-4"></i>
            <span><strong>~13åˆ†é’Ÿ (2 Epochs):</strong> å˜æˆ <span class="text-green-400 font-bold">Finalized</span>ã€‚æ­¤æ—¶äº¤æ˜“ä¸å¯é€†ã€‚</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Slide 9: Summary & Quiz -->
  <div class="slide flex-col max-w-4xl w-full h-full text-center" id="slide-8">
    <h2 class="text-3xl font-bold mb-6">æ€»ç»“ä¸æµ‹è¯•</h2>

    <div class="glass p-8 rounded-2xl w-full text-left mb-8">
      <h3 class="text-xl font-bold mb-4 text-indigo-400">çŸ¥è¯†ç‚¹å›é¡¾</h3>
      <ul class="space-y-2 text-slate-300">
        <li>âœ… <strong>è´¦æˆ·</strong>ï¼šEOA (äºº) å’Œ CA (åˆçº¦) æ˜¯ä¸¤ç±»å®ä½“ã€‚</li>
        <li>âœ… <strong>Gas</strong>ï¼šé˜²æ­¢æ»¥ç”¨çš„è´¹ç”¨ï¼Œç”± Base Fee (é”€æ¯) + Tip (å°è´¹) ç»„æˆã€‚</li>
        <li>âœ… <strong>Data</strong>ï¼šè½¬è´¦ ETH ä¸ºç©ºï¼Œè½¬è´¦ä»£å¸åˆ™æ˜¯å‡½æ•°è°ƒç”¨ç¼–ç ã€‚</li>
        <li>âœ… <strong>Nonce</strong>ï¼šé˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œå†³å®šäº¤æ˜“é¡ºåºã€‚</li>
      </ul>
    </div>

    <div class="glass p-6 rounded-xl w-full">
      <p class="mb-4 font-bold text-lg">å°æµ‹éªŒï¼šå¦‚æœä½ æƒ³å–æ¶ˆä¸€ç¬”å¡ä½çš„äº¤æ˜“ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onclick="checkAnswer(false, this)" class="p-3 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors">ç»™æ—§äº¤æ˜“å‘ä¸ªé‚®ä»¶å‚¬ä¸€ä¸‹</button>
        <button onclick="checkAnswer(true, this)" class="p-3 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors">å‘é€ä¸€ç¬” Nonce ç›¸åŒä½† Gas æ›´é«˜çš„æ–°äº¤æ˜“</button>
        <button onclick="checkAnswer(false, this)" class="p-3 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors">å‘é€ä¸€ç¬” Nonce + 1 çš„äº¤æ˜“</button>
        <button onclick="checkAnswer(false, this)" class="p-3 bg-slate-700 hover:bg-slate-600 rounded text-sm transition-colors">åˆ é™¤é’±åŒ…APPé‡è£…</button>
      </div>
      <p id="feedback-msg" class="mt-4 h-6 text-sm font-bold"></p>
    </div>
  </div>

  <!-- Slide 10: End -->
  <div class="slide flex-col items-center justify-center text-center h-full" id="slide-9">
    <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
    <h2 class="text-4xl font-bold mb-4">å­¦ä¹ å®Œæˆ</h2>
    <p class="text-slate-400 max-w-md">ä½ ç°åœ¨å·²ç»ç†è§£äº†ä»¥å¤ªåŠè¿™å°â€œä¸–ç•Œè®¡ç®—æœºâ€æ¯ä¸€æ¬¡å¿ƒè·³èƒŒåçš„ç§˜å¯†ã€‚</p>
    <button onclick="goToSlide(0)" class="mt-8 px-6 py-2 border border-slate-600 rounded hover:bg-slate-800 text-slate-300">
      é‡å¤´å†çœ‹
    </button>
  </div>

</main>

<!-- Floating AI Button -->
<button onclick="toggleChat()" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 hover:bg-indigo-500 rounded-full shadow-lg shadow-indigo-500/50 flex items-center justify-center z-50 transition-transform hover:scale-110 active:scale-95 group">
  <i class="fas fa-sparkles text-white text-2xl group-hover:animate-pulse"></i>
</button>

<!-- Chat Widget -->
<div id="ai-chat-widget" class="fixed bottom-24 right-6 w-80 md:w-96 h-[500px] glass rounded-xl flex flex-col z-50 transition-all duration-300 transform translate-y-10 opacity-0 pointer-events-none scale-95 origin-bottom-right shadow-2xl overflow-hidden border border-indigo-500/30">
  <!-- Header -->
  <div class="bg-indigo-900/80 p-4 flex justify-between items-center border-b border-indigo-500/30">
    <div class="flex items-center gap-2">
      <i class="fas fa-robot text-indigo-300"></i>
      <div class="flex flex-col leading-none">
        <span class="font-bold text-indigo-100 text-sm">AI åŠ©æ•™ âœ¨</span>
        <span class="text-[10px] text-indigo-400">Gemini 2.5 Flash</span>
      </div>
    </div>
    <button onclick="toggleChat()" class="text-indigo-300 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
  </div>

  <!-- Messages -->
  <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm scrollbar-thin">
    <div class="bg-slate-800/80 p-3 rounded-lg rounded-tl-none border border-slate-700 text-slate-300">
      ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ã€‚
      <br>æˆ‘ä¼šè¯»å–ä½ <strong>å½“å‰è§‚çœ‹çš„é¡µé¢</strong>æ¥å›ç­”é—®é¢˜ã€‚
      <br><br>
      <span class="text-xs text-slate-500">è¯•ç€é—®ï¼š</span>
      <br>
      <button onclick="fillAndSend('ç®€å•æ€»ç»“ä¸€ä¸‹è¿™ä¸€é¡µ')" class="mt-1 text-xs bg-indigo-900/50 hover:bg-indigo-800 px-2 py-1 rounded text-indigo-300 border border-indigo-500/30 transition-colors">âœ¨ ç®€å•æ€»ç»“è¿™ä¸€é¡µ</button>
    </div>
  </div>

  <!-- Input -->
  <div class="p-3 bg-slate-900/90 border-t border-slate-700">
    <div class="relative">
      <input type="text" id="chat-input" placeholder="è¾“å…¥é—®é¢˜ (Enterå‘é€)..." class="w-full bg-slate-800 text-slate-200 rounded-full pl-4 pr-10 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm border border-slate-700 transition-all" onkeypress="if(event.key === 'Enter') askGemini()">
      <button onclick="askGemini()" class="absolute right-2 top-1/2 -translate-y-1/2 text-indigo-400 hover:text-indigo-300 p-2 rounded-full hover:bg-slate-700 transition-all">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<!-- Controls Bottom (Mobile) -->
<div class="md:hidden flex justify-between p-4 bg-slate-900 border-t border-slate-700 z-10">
  <button onclick="prevSlide()" class="bg-slate-800 px-4 py-2 rounded text-slate-300">ä¸Šä¸€é¡µ</button>
  <button onclick="nextSlide()" class="bg-indigo-600 px-4 py-2 rounded text-white">ä¸‹ä¸€é¡µ</button>
</div>

<script>
  let currentSlide = 0;
  const totalSlides = 10;
  const progressBar = document.getElementById('progress-bar');
  const slideCounter = document.getElementById('slide-counter');
  const apiKey = ""; // Runtime injection

  // Data for Detail View
  const details = {
    'nonce': {
      title: 'Nonce (è®¡æ•°å™¨)',
      color: 'text-indigo-300',
      content: 'è¿™ä¸ªæ•°å­—é˜²æ­¢â€œé‡æ”¾æ”»å‡»â€ã€‚æ¯”å¦‚ä½ ç»™Aè½¬è´¦10å…ƒï¼Œå¦‚æœä¸å¸¦Nonceï¼Œé»‘å®¢å¯ä»¥æˆªè·è¿™ä¸²æ•°æ®å¹¿æ’­10æ¬¡ï¼Œä½ çš„é’±å°±æ²¡äº†ã€‚Nonceå¼ºåˆ¶äº¤æ˜“å¿…é¡»æŒ‰ 0, 1, 2... çš„é¡ºåºæ‰§è¡Œã€‚'
    },
    'gas': {
      title: 'Gas Fee (æ±½æ²¹è´¹)',
      color: 'text-pink-300',
      content: 'å…¬å¼ï¼šGas Units (å·¥ä½œé‡) Ã— Gas Price (å•ä»·)ã€‚\nè½¬è´¦å›ºå®š 21000 Unitsã€‚\nPrice = Base Fee (ç³»ç»Ÿé”€æ¯) + Priority Fee (ç»™çŸ¿å·¥çš„å°è´¹)ã€‚'
    },
    'to': {
      title: 'To (æ¥æ”¶åœ°å€)',
      color: 'text-blue-300',
      content: 'è¿™æ˜¯ä¸€ä¸ª 20å­—èŠ‚ çš„å“ˆå¸Œå€¼ã€‚å¦‚æœæ˜¯æ™®é€šè½¬è´¦ï¼Œè¿™é‡Œæ˜¯æ”¶æ¬¾äººé’±åŒ…ã€‚å¦‚æœæ˜¯è°ƒç”¨æ™ºèƒ½åˆçº¦ï¼ˆå¦‚è½¬ USDTï¼‰ï¼Œè¿™é‡Œå…¶å®æ˜¯ USDT çš„åˆçº¦åœ°å€ï¼'
    },
    'value': {
      title: 'Value (é‡‘é¢)',
      color: 'text-green-300',
      content: 'è¿™é‡Œä»…ä»£è¡¨åŸç”Ÿä»£å¸ ETH çš„æ•°é‡ï¼ˆä»¥ Wei ä¸ºå•ä½ï¼Œ1 ETH = 10^18 Weiï¼‰ã€‚è½¬è´¦ USDT æ—¶ï¼Œè¿™é‡Œçš„ Value é€šå¸¸æ˜¯ 0ã€‚'
    },
    'data': {
      title: 'Data (è¾“å…¥æ•°æ®)',
      color: 'text-yellow-300',
      content: 'æ™®é€šè½¬è´¦æ—¶ä¸ºç©º (0x)ã€‚\nè°ƒç”¨åˆçº¦æ—¶åŒ…å«ï¼šå‡½æ•°é€‰æ‹©å™¨ (å‰4å­—èŠ‚) + å‚æ•°ã€‚ä¾‹å¦‚ `a9059cbb` ä»£è¡¨ transfer(address,uint256)ã€‚'
    },
    'sig': {
      title: 'v, r, s (æ•°å­—ç­¾å)',
      color: 'text-purple-300',
      content: 'è¿™æ˜¯ç”¨ä½ çš„ç§é’¥å¯¹äº¤æ˜“å“ˆå¸Œè¿›è¡Œ ECDSA ç­¾åç”Ÿæˆçš„ä¸‰ä¸ªå€¼ã€‚ä»¥å¤ªåŠæ²¡æœ‰â€œå‘ä»¶äººFromâ€å­—æ®µï¼ŒèŠ‚ç‚¹é€šè¿‡ v,r,s åå‘è®¡ç®—å‡ºæ˜¯è°å‘èµ·çš„äº¤æ˜“ã€‚'
    }
  };

  function updateUI() {
    // Hide all slides
    document.querySelectorAll('.slide').forEach(s => {
      s.classList.remove('active');
    });

    // Show current
    const currentSlideEl = document.getElementById(`slide-${currentSlide}`);
    if (currentSlideEl) {
      currentSlideEl.classList.add('active');
    }

    // Update Progress
    const progress = ((currentSlide + 1) / totalSlides) * 100;
    progressBar.style.width = `${progress}%`;
    slideCounter.innerText = `${currentSlide + 1} / ${totalSlides}`;
  }

  function nextSlide() {
    if (currentSlide < totalSlides - 1) {
      currentSlide++;
      updateUI();
    }
  }

  function prevSlide() {
    if (currentSlide > 0) {
      currentSlide--;
      updateUI();
    }
  }

  function goToSlide(index) {
    currentSlide = index;
    updateUI();
  }

  // Keyboard Nav
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
    if (e.key === 'ArrowLeft') prevSlide();
  });

  // Interactive Functions
  function showTxDetail(key) {
    const data = details[key];
    const container = document.getElementById('tx-detail-content');

    container.innerHTML = `
                <h3 class="text-2xl font-bold ${data.color} mb-4">${data.title}</h3>
                <p class="text-slate-300 text-left leading-relaxed whitespace-pre-line">${data.content}</p>
            `;
  }

  function updateMempoolViz() {
    const input = document.getElementById('prio-fee');
    if (!input) return; // Guard in case element doesn't exist on page load
    const userFee = parseFloat(input.value) || 0;

    const viz = document.getElementById('mempool-viz');
    const estTime = document.getElementById('est-time');
    const totalCostDisplay = document.getElementById('total-cost-display');

    if (!viz || !estTime || !totalCostDisplay) return;

    // Mock Data
    let fees = [0.5, 0.8, 1.0, 1.2, 1.5, 1.8, 2.0, 2.2, 2.5, 3.0, 4.0, 6.0];

    // Render Bars
    viz.innerHTML = '';
    fees.push(userFee);
    fees.sort((a, b) => a - b);

    fees.forEach(fee => {
      const isUser = fee === userFee;
      const percent = Math.min((fee / 8) * 100, 100);

      const bar = document.createElement('div');
      bar.className = `h-4 rounded-full transition-all duration-300 flex items-center px-2 text-[10px] ${
              isUser
                      ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)] z-10 scale-105 border border-white'
                      : 'bg-slate-700 opacity-60'
      }`;
      bar.style.width = `${Math.max(percent, 10)}%`;

      if (isUser) {
        bar.innerHTML = `<span class="font-bold text-white whitespace-nowrap">YOU (${fee} Gwei)</span>`;
      }

      viz.appendChild(bar);
    });

    // Calculate Estimate
    if (userFee < 1.0) {
      estTime.innerText = "> 5 åˆ†é’Ÿ (å®¹æ˜“å¡ä½)";
      estTime.className = "text-xl font-bold text-red-500";
    } else if (userFee < 2.0) {
      estTime.innerText = "~ 1 - 3 åˆ†é’Ÿ";
      estTime.className = "text-xl font-bold text-yellow-500";
    } else if (userFee < 3.0) {
      estTime.innerText = "< 30 ç§’ (ä¸‹ä¸€åŒºå—)";
      estTime.className = "text-xl font-bold text-green-400";
    } else {
      estTime.innerText = "ğŸš€ æé€Ÿ (ç«‹åˆ»æ‰“åŒ…)";
      estTime.className = "text-xl font-bold text-green-300 neon-text";
    }

    // Calc Total Cost
    const baseFee = 15;
    const gasLimit = 21000;
    const totalGwei = (baseFee + userFee) * gasLimit;
    const totalEth = (totalGwei * 0.000000001).toFixed(6);
    totalCostDisplay.innerText = `${totalEth} ETH`;
  }

  function setFee(val) {
    const input = document.getElementById('prio-fee');
    if (input) {
      input.value = val;
      updateMempoolViz();
    }
  }

  function accelerateTx() {
    const input = document.getElementById('prio-fee');
    if (input) {
      let current = parseFloat(input.value) || 0;
      let newVal = (current * 1.3).toFixed(2);
      input.value = newVal;

      const btn = document.querySelector('button[onclick="accelerateTx()"]');
      if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-check"></i> å·²åŠ é€Ÿ!`;
        btn.classList.add('bg-green-600');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('bg-green-600');
        }, 1000);
      }
      updateMempoolViz();
    }
  }

  function checkAnswer(isCorrect, btn) {
    const msg = document.getElementById('feedback-msg');
    if (isCorrect) {
      msg.innerText = "æ­£ç¡®ï¼è¿™æ˜¯åˆ©ç”¨äº† Nonce è¦†ç›–æœºåˆ¶ã€‚";
      msg.className = "mt-4 h-6 text-sm font-bold text-green-400";
      btn.classList.add('bg-green-600', 'text-white');
    } else {
      msg.innerText = "ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ Nonce çš„åŸç†ã€‚";
      msg.className = "mt-4 h-6 text-sm font-bold text-red-400";
      btn.classList.add('bg-red-600', 'text-white');
    }
  }

  async function runStateAnimation() {
    const aliceVal = document.getElementById('anim-alice-val');
    const bobVal = document.getElementById('anim-bob-val');
    const tx = document.getElementById('anim-tx');
    const gear = document.getElementById('anim-gear');
    const ring = document.getElementById('anim-evm-ring');
    const status = document.getElementById('anim-status');
    const aliceBox = document.getElementById('anim-alice-box');
    const bobBox = document.getElementById('anim-bob-box');
    const stage = document.getElementById('anim-stage');

    if (!aliceVal || !bobVal || !tx || !gear || !ring || !status || !aliceBox || !bobBox || !stage) return;

    // 1. Reset State
    aliceVal.innerText = "10 ETH";
    bobVal.innerText = "0 ETH";
    aliceVal.className = "font-mono text-white font-bold text-sm";
    bobVal.className = "font-mono text-white font-bold text-sm";
    status.innerText = "çŠ¶æ€ Ïƒ (åˆå§‹): Alice=10, Bob=0";
    status.className = "mt-6 text-sm text-slate-400 font-mono h-6 text-center";
    aliceBox.classList.remove('border-yellow-500', 'shadow-[0_0_15px_rgba(234,179,8,0.5)]');
    bobBox.classList.remove('border-green-500', 'shadow-[0_0_15px_rgba(34,197,94,0.5)]');
    ring.classList.remove('shadow-[0_0_50px_rgba(99,102,241,0.8)]', 'bg-indigo-800');

    // Step 2: Create Tx
    await new Promise(r => setTimeout(r, 300));
    status.innerText = "ç”Ÿæˆäº¤æ˜“ T: Alice è½¬è´¦ 2 ETH";
    status.className = "mt-6 text-sm text-yellow-400 font-bold font-mono h-6 text-center";
    aliceBox.classList.add('border-yellow-500', 'shadow-[0_0_15px_rgba(234,179,8,0.5)]');

    const startTop = aliceBox.offsetTop + aliceBox.offsetHeight / 2 - 20;
    const startLeft = aliceBox.offsetLeft + aliceBox.offsetWidth / 2 - 20;

    tx.style.transition = 'none';
    tx.style.top = startTop + 'px';
    tx.style.left = startLeft + 'px';
    tx.style.transform = 'scale(0.5)';
    tx.style.opacity = '1';

    await new Promise(r => setTimeout(r, 100)); // Render frame

    // Step 3: Move Tx to Center
    tx.style.transition = 'all 1s cubic-bezier(0.4, 0, 0.2, 1)';
    tx.style.top = '50%'; // Center of stage
    tx.style.left = '50%';
    tx.style.transform = 'translate(-50%, -100%) scale(1.2)';

    await new Promise(r => setTimeout(r, 1000));

    // Step 4: EVM Processing
    status.innerText = "EVM è®¡ç®—: Ïƒ' = Î¥(Ïƒ, T)";
    status.className = "mt-6 text-sm text-indigo-400 font-bold font-mono h-6 text-center animate-pulse";
    gear.classList.add('animate-spin');
    ring.classList.add('shadow-[0_0_50px_rgba(99,102,241,0.8)]', 'bg-indigo-800');

    tx.style.transition = 'all 0.5s ease-in';
    tx.style.transform = 'translate(-50%, 50%) scale(0)';
    tx.style.opacity = '0';

    await new Promise(r => setTimeout(r, 1500));

    // Step 5: Finalize
    gear.classList.remove('animate-spin');
    ring.classList.remove('shadow-[0_0_50px_rgba(99,102,241,0.8)]', 'bg-indigo-800');
    status.innerText = "çŠ¶æ€æ›´æ–°å®Œæˆ Ïƒ': Alice=8, Bob=2";
    status.className = "mt-6 text-sm text-green-400 font-bold font-mono h-6 text-center";

    aliceBox.classList.remove('border-yellow-500', 'shadow-[0_0_15px_rgba(234,179,8,0.5)]');

    aliceVal.innerText = "8 ETH";
    aliceVal.className = "font-mono text-red-400 font-bold text-sm transition-colors duration-300";

    bobVal.innerText = "2 ETH";
    bobVal.className = "font-mono text-green-400 font-bold text-sm transition-colors duration-300";
    bobBox.classList.add('border-green-500', 'shadow-[0_0_15px_rgba(34,197,94,0.5)]');
  }

  // ==========================================
  // Journey Animation (Slide 7)
  // ==========================================
  async function runJourneyAnim() {
    const ball = document.getElementById('j-tx-ball');
    const botFront = document.getElementById('bot-tx-front');
    const botBack = document.getElementById('bot-tx-back');
    const botLabel = document.getElementById('sandwich-bot');
    const finalityBadge = document.getElementById('finality-badge');
    const finalityText = document.getElementById('finality-text');
    const stage = document.getElementById('journey-stage');

    if(!ball || !stage) return;

    // Reset
    ball.style.transition = 'none';
    ball.style.opacity = '0';
    ball.style.left = '10%'; // Wallet position
    ball.style.top = '50%';
    ball.style.transform = 'translate(-50%, -50%)';
    ball.classList.remove('bg-green-500', 'border-green-200');
    ball.classList.add('bg-yellow-400');

    botFront.style.opacity = '0';
    botBack.style.opacity = '0';
    botLabel.style.opacity = '0';

    finalityBadge.classList.replace('bg-green-500', 'bg-yellow-500');
    finalityBadge.innerHTML = '<i class="fas fa-clock"></i>';
    finalityText.innerText = "ç­‰å¾… Justified...";
    finalityText.className = "text-[10px] text-slate-400";

    await new Promise(r => setTimeout(r, 100));

    // 1. Sign & Appear
    ball.style.opacity = '1';
    ball.style.transition = 'all 1s ease-in-out';

    // 2. Move to Mempool (Middle)
    await new Promise(r => setTimeout(r, 500));
    ball.style.left = '50%';

    // 3. MEV Attack! (Sandwich)
    await new Promise(r => setTimeout(r, 1000));
    botLabel.style.opacity = '1';

    // Bot Front-run (Top)
    botFront.style.left = '50%';
    botFront.style.top = '30%';
    botFront.style.opacity = '1';

    // Bot Back-run (Bottom)
    botBack.style.left = '50%';
    botBack.style.top = '70%';
    botBack.style.opacity = '1';

    await new Promise(r => setTimeout(r, 800));
    // Squeeze effect
    botFront.style.top = '40%';
    botBack.style.top = '60%';

    await new Promise(r => setTimeout(r, 500));
    botLabel.style.opacity = '0';
    botFront.style.opacity = '0';
    botBack.style.opacity = '0';

    // 4. Move to Block
    ball.style.left = '90%';

    await new Promise(r => setTimeout(r, 1000));

    // 5. Finality
    ball.classList.replace('bg-yellow-400', 'bg-green-500');
    ball.classList.add('border-green-200');

    finalityBadge.classList.replace('bg-yellow-500', 'bg-green-500');
    finalityBadge.innerHTML = '<i class="fas fa-check"></i>';

    finalityText.innerText = "Finalized (ä¸å¯é€†)";
    finalityText.className = "text-[10px] text-green-400 font-bold";
  }

  // Gemini AI Integration
  // ==========================================
  let isChatOpen = false;

  function toggleChat() {
    const widget = document.getElementById('ai-chat-widget');
    isChatOpen = !isChatOpen;

    if (isChatOpen) {
      widget.classList.remove('opacity-0', 'pointer-events-none', 'scale-95', 'translate-y-10');
      document.getElementById('chat-input').focus();
    } else {
      widget.classList.add('opacity-0', 'pointer-events-none', 'scale-95', 'translate-y-10');
    }
  }

  function fillAndSend(text) {
    document.getElementById('chat-input').value = text;
    askGemini();
  }

  function appendMessage(text, type, loading = false) {
    const container = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');

    if (type === 'user') {
      msgDiv.className = 'bg-indigo-600/80 p-3 rounded-lg rounded-tr-none text-white self-end ml-8';
      msgDiv.innerText = text;
    } else {
      msgDiv.className = 'bg-slate-800/80 p-3 rounded-lg rounded-tl-none border border-slate-700 text-slate-300 ai-response';
      msgDiv.innerHTML = text; // Use innerHTML for formatting
    }

    if (loading) {
      msgDiv.id = 'loading-msg';
      msgDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin text-indigo-400"></i> æ€è€ƒä¸­...';
    }

    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
    return msgDiv;
  }

  function removeMessage(el) {
    if (el) el.remove();
  }

  async function askGemini() {
    const input = document.getElementById('chat-input');
    const userText = input.value.trim();
    if (!userText) return;

    // 1. Add User Message
    appendMessage(userText, 'user');
    input.value = '';

    // 2. Get Context (Current Slide Text)
    // Use querySelector to find the currently active slide
    const currentSlideEl = document.getElementById(`slide-${currentSlide}`);
    // Extract text, remove excessive whitespace
    const contextText = currentSlideEl ? currentSlideEl.innerText.replace(/\s+/g, ' ').substring(0, 1500) : "Overview of Ethereum Transactions";

    // 3. Show Loading
    const loadingMsg = appendMessage('', 'ai', true);

    try {
      // 4. Construct Prompt
      const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä»¥å¤ªåŠä¸“å®¶ AI åŠ©æ•™ã€‚ç”¨æˆ·æ­£åœ¨è§‚çœ‹ä¸€ä¸ªå…³äºä»¥å¤ªåŠè½¬è´¦åŸç†çš„å¹»ç¯ç‰‡ã€‚

                ç”¨æˆ·å½“å‰çš„é¡µé¢å†…å®¹æ˜¯ï¼š
                """${contextText}"""

                è¯·æ ¹æ®é¡µé¢å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
                - å¦‚æœé—®é¢˜ä¸é¡µé¢å†…å®¹ç›¸å…³ï¼Œç»“åˆé¡µé¢å†…å®¹è§£é‡Šã€‚
                - ä½¿ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ï¼ˆå°ç™½å¬å¾—æ‡‚ï¼‰ã€‚
                - å¯ä»¥ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆå¦‚ **åŠ ç²—**ï¼Œ\`ä»£ç \`ï¼‰ã€‚
                - å›ç­”è¦ç®€ç»ƒï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚`;

      // 5. Call API
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userText }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });

      if (!response.ok) throw new Error('API Error');

      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;

      if (aiText) {
        // Simple Markdown parsing for display
        const formattedText = aiText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

        removeMessage(loadingMsg);
        appendMessage(formattedText, 'ai');
      } else {
        throw new Error('No content');
      }

    } catch (e) {
      console.error(e);
      removeMessage(loadingMsg);
      appendMessage("ç½‘ç»œå¼€å°å·®äº†ï¼Œè¯·é‡è¯•ä¸€ä¸‹ ğŸ˜…", 'ai');
    }
  }

  // Init - Important: Wait for DOM or just run
  // Since we are at end of body, it's fine.
  updateUI();
  // Initialize visualization for gas simulator (even though hidden initially)
  updateMempoolViz();

</script>

<style>
  @keyframes slide-right {
    0% { left: 0; width: 0; opacity: 1; }
    50% { width: 50%; }
    100% { left: 100%; width: 0; opacity: 0; }
  }
  .animate-slide-right {
    animation: slide-right 2s infinite linear;
  }
</style>
</body>
</html>